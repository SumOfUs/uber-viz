---
title: How Uber Rolls
---
<div class="uber-viz">
  <h1 class="uber-viz__title">Why so many people are so mad at Uber</h1>
  <div class="map-graphic">
    <div id="map-bubbles-chart" class="map-graphic__component"></div>
    <div id="us-states-map" class="map-graphic__component"></div>
  </div>
  <div id="type-chart"></div>
  <div id="stories-table"></div>
</div>

<script type="text/template" id="incident-card-template">
  <div class="incident-card">
    <div class="incident-card__type" style="background-color: {{ color }}">
      {{ d.type }} - {{ d.location }}
    </div>
    <div class="incident-card__main">
      <div class="incident-card__tagline">{{ d.tagline }}</div>
      <div class="incident-card__summary">{{ d.summary }}</div>
      <a href="{{ d.link_1 }}" class="incident-card__source" target="_blank">Source</a>
    </div>
  </div>
</script>

<script type="text/javascript" src='https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore.js'></script>
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/crossfilter/1.3.12/crossfilter.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/dc/2.0.1/dc.css" />
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/dc/2.0.1/dc.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-tip/0.6.3/d3-tip.min.js"></script>
<script src="/javascripts/dc-tooltip.js"></script>


<script>
var width = 960,
    height = 500;

var projection = d3.geo.albers();
var path = d3.geo.path()
    .projection(projection);

var mapSvg = d3.select("#us-states-map").append("svg")
    .attr("width", width)
    .attr("height", height);

var bubbleSvg = d3.select('#map-bubbles-chart').append('svg')
    .attr("width", width)
    .attr("height", height);

var typeSvg = d3.select('#type-chart').append('svg')
    .attr("width", 300)
    .attr("height", 400);

var categoryColors = {
  "Corporate citizenship": '#3182bd',
  "Data issues": '#6baed6',
  "Legacy industry": '#9ecae1',
  "Lobbying": 'white',
  "Pay": '#e6550d',
  "Predatory finance": '#fd8d3c',
  "Regulation": '#fdae6b',
  "Tax": '#31a354',
  "Worker classification": '#74c476'
};
var colorDomain = [];
var colorRange = [];
_.each(categoryColors, function(v, k) { colorDomain.push(k); colorRange.push(v); });

d3.csv('/javascripts/uber-cities.csv', function(error, cities){
  if (error) console.error(error);

  var ndx = crossfilter(cities);
  var locationDimension = ndx.dimension(function(d) { return d.location; });
  var locationGroup = locationDimension.group().reduce(
    function (p, v) {
      if (p.lat !== v.lat) p.lat = v.lat;
      if (p.long !== v.long) p.long = v.long;
      p.count++;
      if (p.typeCounts.hasOwnProperty(v.type)) {
        p.typeCounts[v.type]++;
      } else {
        p.typeCounts[v.type] = 1;
      }
      p.taglines = _.union(p.taglines, [v.tagline]);
      p.location = v.location;
      return p;
    },
    function (p, v) {
      p.count--;
      p.typeCounts[v.type]--;
      if (p.typeCounts[v.type] < 1) delete p.typeCounts[v.type];
      p.taglines = _.difference(p.taglines, [v.tagline]);
      return p;
    },
    function () {
      return {
        lat: null,
        long: null,
        typeCounts: {},
        taglines: [],
        count: 0
      };
    }
  );
  var typeDimension = ndx.dimension(function(d) { return d.type; });
  var typeGroup = typeDimension.group().reduce(
    function(p, v){ return p },
    function(p, v){ return p },
    function(){ return 100 }
  );

  var mapBubbles = dc.bubbleChart('#map-bubbles-chart')
    .svg(d3.select('#map-bubbles-chart svg'))
    .width(width*1.08)
    .height(height*1.15)
    .dimension(locationDimension)
    .group(locationGroup)
    .keyAccessor(function(p) {
      projected = projection([p.value.long, p.value.lat]);
      return projected ? projected[0] : 0;
    })
    .valueAccessor(function(p) {
      projected = projection([p.value.long, p.value.lat]);
      return projected ? -projected[1] : 0;
    })
    .radiusValueAccessor(function(p) { return p.value.count; })
    .x(d3.scale.linear().domain([0, 960]))
    .y(d3.scale.linear().domain([-500, 0]))
    .title(function(p) {
      taglines = '<li>'+p.value.taglines.join('</li><li>').slice(0,-4);
      return "<div class='bubble-chart__taglines'><h4>"+p.value.location+"</h4><ul>"+taglines+"</ul></div>";
    })
    .colorAccessor(function(p) {
      var max = _.chain(p.value.typeCounts).max().value();
      type = _.chain(p.value.typeCounts).invert().value()[max];
      return type;
    })
    .colors(d3.scale.ordinal().domain(colorDomain).range(colorRange))
    .addFilterHandler(function(filters, filter){
      filters.length = 0; // empty the array
      filters.push(filter);
      return filters;
    })
    .renderLabel(false)
  ;

  var types = dc.rowChart('#type-chart')
    .svg(d3.select('#type-chart svg'))
    .width(250)
    .height(400)
    .dimension(typeDimension)
    .group(typeGroup)
    .elasticX(false);
  ;

  var incidentTemplate = d3.select('#incident-card-template').html();
  _.templateSettings = {
    interpolate: /\{\{(.+?)\}\}/g
  };
  var table = dc.dataGrid('#stories-table')
    .dimension(typeDimension)
    .group(function(d) { return d; })
    .size(100)
    .html(function(d) {
      return _.template(incidentTemplate)({d: d, color: categoryColors[d.type]});
    });
  ;

  dc.renderAll();
  dc.tooltipMixin(mapBubbles);
  // mapBubbles.tip.elements.on('mouseleave', null);
});

d3.json("/javascripts/us.json", function(error, us) {

  mapSvg.append("path")
      .attr("class", "states")
      .datum(topojson.feature(us, us.objects.states))
      .attr("d", path);

});

</script>
